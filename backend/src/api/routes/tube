// backend/src/api/routes/youTubeRouter.js
import express from 'express';
import fetch from 'node-fetch'; // Make sure node-fetch is installed (npm install node-fetch)
import dotenv from 'dotenv'; // Make sure dotenv is installed (npm install dotenv)

dotenv.config(); // Loads environment variables from .env file

const youTubeRouter = express.Router();

youTubeRouter.get('/search', async (req, res) => {
  const query = req.query.q;

  if (!query) {
    console.warn("Youtube API: Query parameter 'q' is missing.");
    return res.status(400).json({ error: "Query parameter is required" });
  }

  try {
    const API_KEY = process.env.YOUTUBE_API_KEY;

    // Debugging: Log whether API key is loaded
    console.log("Backend: YouTube API Key Status:", API_KEY ? "Loaded" : "NOT LOADED - Check .env file!");

    if (!API_KEY) {
      console.error("YouTube API key is not configured in .env. Please ensure it's set.");
      return res.status(500).json({ error: "API configuration error: YouTube API key missing" });
    }

    // Make the actual API call to Youtube
    const searchResponse = await fetch(
      `https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=5&q=${encodeURIComponent(query)}&type=video&videoDuration=medium&videoDefinition=high&key=${API_KEY}`,
    );

    if (!searchResponse.ok) {
      const errorText = await searchResponse.text();
      console.error(`Youtube API request failed: ${searchResponse.status} - ${errorText}`);
      // Propagate the actual YouTube API error message if possible
      try {
        const errorJson = JSON.parse(errorText);
        return res.status(searchResponse.status).json({ error: errorJson.error?.message || `YouTube API error: ${errorText}` });
      } catch (parseError) {
        return res.status(searchResponse.status).json({ error: `YouTube API error: ${errorText}` });
      }
    }

    const searchData = await searchResponse.json();

    if (!searchData.items || searchData.items.length === 0) {
      console.log(`No YouTube videos found for query: "${query}"`);
      return res.json({ videos: [] }); // No videos found
    }

    // Get video IDs for duration lookup
    const videoIds = searchData.items.map((item) => item.id.videoId).join(",");

    // Fetch video details including duration
    const detailsResponse = await fetch(
      `https://www.googleapis.com/youtube/v3/videos?part=contentDetails&id=${videoIds}&key=${API_KEY}`,
    );

    const videoDurations = {};
    if (detailsResponse.ok) {
      const detailsData = await detailsResponse.json();
      detailsData.items?.forEach((item) => {
        // Convert ISO 8601 duration to readable format
        const duration = item.contentDetails.duration;
        const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);

        let hours = Number.parseInt(match[1] || 0);
        let minutes = Number.parseInt(match[2] || 0);
        let seconds = Number.parseInt(match[3] || 0);

        let formattedDuration = "";
        if (hours > 0) formattedDuration += `${hours}:`;
        formattedDuration += `${minutes.toString().padStart(hours > 0 ? 2 : 1, "0")}:`;
        formattedDuration += seconds.toString().padStart(2, "0");

        videoDurations[item.id] = formattedDuration;
      });
    } else {
        const errorText = await detailsResponse.text();
        console.warn(`YouTube details API request failed: ${detailsResponse.status} - ${errorText}`);
        // Do not throw, just log and continue without durations if details fetch fails
    }

    // Format the response for the frontend
    const formattedVideos = searchData.items.map((video) => ({
      id: video.id.videoId,
      title: video.snippet.title,
      thumbnail: video.snippet.thumbnails.medium?.url || video.snippet.thumbnails.default?.url,
      channel: video.snippet.channelTitle,
      duration: videoDurations[video.id.videoId] || "Unknown",
      description: video.snippet.description?.substring(0, 100) + "..." || "",
      publishedAt: video.snippet.publishedAt,
    }));

    return res.json({ videos: formattedVideos });

  } catch (error) {
    console.error("Error fetching YouTube videos in backend:", error); // Changed for clarity

    // Fallback content in case of API failure
    // These fallback videos should have valid YouTube IDs (though they won't play with these specific IDs)
    // For actual fallbacks, you'd want pre-selected, known good YouTube video IDs.
    const fallbackVideos = [
      {
        id: "S7P2yR5Q_2Q", // Example YouTube video ID for guided breathing
        title: "Guided Breathing Exercise - 5 Minutes (Fallback)",
        thumbnail: "https://i.ytimg.com/vi/S7P2yR5Q_2Q/mqdefault.jpg", // Example placeholder thumbnail
        channel: "Mindfulness Guides",
        duration: "5:00",
        description: "A gentle breathing exercise to calm your mind...",
        isFallback: true,
      },
      {
        id: "aL3Fh4YJ3eU", // Example YouTube video ID for meditation
        title: "Beginner's Meditation - 10 Minutes (Fallback)",
        thumbnail: "https://i.ytimg.com/vi/aL3Fh4YJ3eU/mqdefault.jpg", // Example placeholder thumbnail
        channel: "Calm Mind",
        duration: "10:00",
        description: "Find peace through mindful awareness...",
        isFallback: true,
      },
    ];

    return res.status(500).json({
      videos: fallbackVideos, // Still return videos, but flag them as fallback
      fallback: true,
      error: `Failed to fetch videos from YouTube: ${error.message || 'Unknown error'}`,
    });
  }
});

export default youTubeRouter;
